<script type="module">
	import { run, memfs } from "./dist/yarn-browser.es.js";

	(async () => {
		await new Promise((res) => setTimeout(() => res(), 1000));

		memfs.mkdirSync("/tmp");
		memfs.mkdirSync("/app");
		memfs.writeFileSync(
			"/app/package.json",
			JSON.stringify(
				{
					dependencies: {
						"lodash-es": "^4.17.15",
						react: "latest",
						"react-dom": "latest",
					},
				},
				null,
				2
			)
		);

		const dir = "/app";

		console.log("Starting Yarn");
		console.time("Finished");
		let { report, messages } = await run({ dir, fs: memfs });
		console.timeEnd("Finished");

		console.log(report);
		for (let { type, indent, data, displayName } of messages) {
			let msg = `[${displayName}] ${indent} ${data}`;
			console.log(
				"%c" + msg,
				`color: ${
					type === "error" ? "red" : "white"
				}; font-family: monospace;`
			);
		}
		if (report.reportedErrors.size > 0) throw [...report.reportedErrors][0];

		console.log(memfs.readdirSync("/app"));
		console.log(memfs.readdirSync("/app/node_modules"));
	})().catch((e) => {
		console.error(e);
	});
</script>
